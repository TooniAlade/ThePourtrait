<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marble Art Gallery - ThePourtrait</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            text-align: center;
            padding: 2rem 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .art-display {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            height: auto;
        }

        .art-image {
            width: 100%;
            height: auto;
            border-radius: 15px;
        }

        .art-info {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #667eea;
        }

        .art-info h3 {
            color: #4a5568;
            margin-bottom: 1rem;
        }

        .interaction-panel {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .generate-section {
            margin-bottom: 2rem;
        }

        .generate-section h2 {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .generate-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .email-section h2 {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .email-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(72, 187, 120, 0.3);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .button-group .send-btn {
            flex: 1;
            min-width: 150px;
        }

        /* Reset row below email/download buttons */
        .reset-row {
            margin-top: 10px;
            display: flex;
            width: 100%;
        }
        .reset-row .send-btn {
            width: 100%;
        }

        .status-message {
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .status-success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }

        .status-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .status-info {
            background: #bee3f8;
            color: #2b6cb0;
            border: 1px solid #90cdf4;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .art-placeholder {
            width: 100%;
            height: 400px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.1rem;
        }

        #artContainer {
            position: relative;
            width: 480px;
            height: 400px;
            max-width: 600px;   /* pick a max width */
            aspect-ratio: 1 / 1; /* keeps square, adjust if you want */
            margin: 0 auto;
            overflow: hidden;
        }

        #artContainer img,
        #artContainer canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 480px;
            height: 400px;
            object-fit: contain;
            border-radius: 15px;
            background: white;   /* consistent background */
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ThePourtrait Gallery</h1>
        <p>Create beautiful marble art with interactive paint pouring</p>
    </div>

    <div class="container">
        <div class="art-display">
            <div id="artContainer">
                <div class="art-placeholder">
                    Click "Generate New Art" to create your marble masterpiece!
                </div>
            </div>
            <div class="art-info" id="artInfo" style="display: none;">
                <h3>Generated Art Details</h3>
                <p id="artDetails">Colors and silhouette information will appear here</p>
            </div>
        </div>

        <div class="interaction-panel">
            <div class="generate-section">
                <h2>Create Your Art</h2>
                <button class="generate-btn" id="generateBtn" onclick="generateArt()">
                    Generate New Marble Art
                </button>
                <div id="generateStatus"></div>
            </div>

            <div class="email-section">
                <h2>Get Your Art</h2>
                <form class="email-form" id="emailForm" onsubmit="sendEmail(event)">
                    <div class="form-group">
                        <label for="userName">Your Name:</label>
                        <input type="text" id="userName" name="userName" required 
                               placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email Address:</label>
                        <input type="email" id="userEmail" name="userEmail" required 
                               placeholder="your.email@example.com">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="send-btn" id="sendBtn" disabled>
                            Send to Email
                        </button>
                        <button type="button" class="send-btn" id="downloadBtn" disabled onclick="downloadArt()" 
                                style="background: linear-gradient(45deg, #6c5ce7, #a29bfe);">
                            Download Art
                        </button>
                    </div>
                    <div class="reset-row">
                        <button type="button" class="send-btn" id="resetBtn" onclick="resetFromArduino()"
                                style="background: linear-gradient(45deg, #ef4444, #f97316);">
                            Reset
                        </button>
                    </div>
                </form>
                <div id="emailStatus"></div>
                <div id="resetStatus" style="margin-top: 0.75rem;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentArtPath = null;
        let currentArtInfo = null;

        async function generateArt() {
        const generateBtn = document.getElementById('generateBtn');
        const generateStatus = document.getElementById('generateStatus');
        const sendBtn = document.getElementById('sendBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="loading"></span>Generating Art...';
        generateStatus.innerHTML = '<div class="status-message status-info">Creating your unique marble art...</div>';

        try {
            const response = await fetch('/generate-art', { method: 'POST', headers: { 'Content-Type': 'application/json' }});
            if (!response.ok) throw new Error('Failed to generate art');
            const result = await response.json();

            displayArt(result.imagePath, result.details, result.palette, result.weights);

            sendBtn.disabled = false;
            downloadBtn.disabled = false;
            generateStatus.innerHTML = '<div class="status-message status-success">Art generated successfully!</div>';
        } catch (e) {
            console.error(e);
            generateStatus.innerHTML = '<div class="status-message status-error">Failed to generate art. Please try again.</div>';
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'Generate New Marble Art';
        }
        }

        function hexToRgb(hex){
        const h = hex.replace('#','');
        const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
        return [r,g,b];
        }

        function displayArt(imagePath, details, paletteHex = [], weights = []) {
        const artContainer = document.getElementById('artContainer');
        const artInfo = document.getElementById('artInfo');
        const artDetails = document.getElementById('artDetails');

        currentArtPath = imagePath;
        currentArtInfo = details;


        artContainer.innerHTML = '';
        artContainer.style.position = 'relative';

        // final image element (hidden at the start)
        const img = new Image();
        img.src = imagePath;
        img.alt = "Generated Marble Art";
        img.decoding = "sync";
        img.loading = "eager";
        img.style.display = 'none';
        artContainer.appendChild(img);

        const base = document.createElement('canvas');
        const overlay = document.createElement('canvas');
        base.style.position = overlay.style.position = 'absolute';
        base.style.top = overlay.style.top = '0';
        base.style.left = overlay.style.left = '0';
        base.style.width = overlay.style.width = '100%';
        base.style.height = overlay.style.height = '100%';
        base.style.borderRadius = overlay.style.borderRadius = '15px';
        overlay.style.zIndex = '10';
        overlay.style.pointerEvents = 'none';

        artContainer.appendChild(base);
        artContainer.appendChild(overlay);

        const bctx = base.getContext('2d');
        const octx = overlay.getContext('2d');

        const PALETTE = (paletteHex && paletteHex.length ? paletteHex : (details.colors||[])).map(hexToRgb);
        const FALLBACK = [[230,70,70],[60,120,230],[60,200,120],[255,140,0],[148,0,211],[255,20,147]];
        const palette = PALETTE.length ? PALETTE : FALLBACK;

        let phase = 1, spiralTimer = 0, frame = 0;
        let paintBlobs = [], revealBlobs = [];
        let rafId = null;
        function noise(x,y,base=0){ return Math.sin(x*0.7+base*0.01)*Math.cos(y*0.7+base*0.01)*0.5; }
        function pickColor(white=false){ return white ? [255,255,255] : palette[Math.floor(Math.random()*palette.length)]; }
        function addBlob(color,isReveal=false){
            const W = overlay.width, H = overlay.height;
            const blob = {
            x: isReveal ? 100 + Math.random()*(W-200) : W/2 + (Math.random()-0.5)*120,
            y: isReveal ? 100 + Math.random()*(H-200) : H/2 + (Math.random()-0.5)*120,
            r: 5,
            maxR: isReveal ? 70 + Math.random()*130 : 90 + Math.random()*250,
            growth: isReveal ? 2.5 + Math.random() * 1.5 : 6 + Math.random() * 3,
            spikiness: isReveal ? 40 + Math.random() * 20 : 35 + Math.random() * 20,
            jitter: isReveal ? 20 + Math.random() * 2 : 20 + Math.random() * 3,
            color, life: 0
            };
            (isReveal ? revealBlobs : paintBlobs).push(blob);
        }
        function drawBlob(ctx, blob, erase=false){
            ctx.save();
            const pts=[];
            for(let a=0; a<360; a+=blob.jitter){
            const rad=a*Math.PI/180;
            const n=noise(Math.cos(rad)*0.7+blob.life*0.01, Math.sin(rad)*0.7+blob.life*0.01, blob.life*0.2);
            const nr=blob.r+n*blob.spikiness;
            pts.push({x:blob.x+Math.cos(rad)*nr, y:blob.y+Math.sin(rad)*nr});
            }
            if (erase){ ctx.globalCompositeOperation='destination-out'; ctx.fillStyle='white'; }
            else { ctx.globalCompositeOperation='source-over'; ctx.fillStyle=`rgb(${blob.color[0]},${blob.color[1]},${blob.color[2]})`; }
            ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
            for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
            ctx.closePath(); ctx.fill(); ctx.restore();
        }
        function updatePaintBlobs(){
            for(const b of paintBlobs){ if(b.r<b.maxR) b.r+=b.growth; b.life++; drawBlob(octx, b, false); }
        }
        function applySpiralWave(ctx, t){
            const W=overlay.width, H=overlay.height;
            const img=ctx.getImageData(0,0,W,H);
            const out=ctx.createImageData(W,H);
            const d=img.data, nd=out.data;
            for(let y=0;y<H;y++){
            const off = Math.floor(40 * Math.sin((y/60)+t));
            for(let x=0;x<W;x++){
                let sx=x-off; while(sx<0) sx+=W; while(sx>=W) sx-=W;
                const si=(y*W+sx)*4, ti=(y*W+x)*4;
                nd[ti]=d[si]; nd[ti+1]=d[si+1]; nd[ti+2]=d[si+2]; nd[ti+3]=d[si+3];
            }
            }
            ctx.putImageData(out,0,0);
        }

        function animate(){
            // phase 1: pour paint (overlay only)
            if (phase===1){
            octx.clearRect(0,0,overlay.width, overlay.height);
            if(frame%2===0) addBlob(pickColor(false));
            updatePaintBlobs();
            if(frame>90) phase=2;
            }
            // phase 2: spiral warp the paint (overlay only)
            else if (phase===2){
            if(frame%2===0) addBlob(pickColor(true));
            updatePaintBlobs();
            spiralTimer += 0.15;
            applySpiralWave(octx, spiralTimer);
            if(spiralTimer>2) phase=3;
            }
            // phase 3: keep carving holes in overlay to reveal final image
            else if (phase===3){
            const WHITE_PAINT_EVERY = 20;
            if (frame % WHITE_PAINT_EVERY === 0 && revealBlobs.length < 40) addBlob([255,255,255], true);
            for (const rb of revealBlobs){ if(rb.r<rb.maxR) rb.r+=rb.growth; rb.life++; }

            // erase holes from overlay 
            for (const rb of revealBlobs) drawBlob(octx, rb, true);
            if (revealBlobs.length > 40 || frame > 300) phase = 4;
            }
            // phase 4: gracefully fade overlay and stop
            else if (phase===4){
            overlay.style.transition = 'opacity 0.6s ease';
            overlay.style.opacity = '0';
            setTimeout(()=>{ overlay.remove(); }, 650);
            return;
            }
            frame++; rafId = requestAnimationFrame(animate);
        }

        img.onload = function(){
            base.width = overlay.width  = img.naturalWidth;
            base.height= overlay.height = img.naturalHeight;

            artContainer.style.aspectRatio = `${img.naturalWidth} / ${img.naturalHeight}`;


            bctx.imageSmoothingEnabled = true;
            bctx.clearRect(0,0,base.width,base.height);
            bctx.drawImage(img, 0, 0, base.width, base.height);


            animate();
        };


        artDetails.innerHTML = `
            <strong>Silhouette:</strong> ${details.silhouette || 'Custom'}<br>
            <strong>Colors:</strong> ${(details.colors || paletteHex || []).join(', ')}<br>
            <strong>Seed:</strong> ${details.seed ?? 'N/A'}<br>
            <strong>Generated:</strong> ${new Date().toLocaleString()}
        `;
        artInfo.style.display = 'block';
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('downloadBtn').disabled = false;
        }

        async function sendEmail(event) {
            event.preventDefault();
            
            const sendBtn = document.getElementById('sendBtn');
            const emailStatus = document.getElementById('emailStatus');
            const userName = document.getElementById('userName').value;
            const userEmail = document.getElementById('userEmail').value;
            
            if (!currentArtPath) {
                emailStatus.innerHTML = '<div class="status-message status-error">❌ Please generate art first!</div>';
                return;
            }
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>Sending Email...';
            emailStatus.innerHTML = '<div class="status-message status-info">📧 Processing your request...</div>';
            
            try {
                const response = await fetch('/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: userName,
                        email: userEmail,
                        artPath: currentArtPath,
                        artInfo: currentArtInfo
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        emailStatus.innerHTML = `
                            <div class="status-message status-success">
                                ✅ Your artwork has been sent to your email.
                                <br><small>Note: Please allow a couple of seconds for the email to show up.</small>
                            </div>`;
                        document.getElementById('emailForm').reset();
                    } else {
                        throw new Error(result.error || 'Failed to process request');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to send email');
                }
                
            } catch (error) {
                console.error('Error sending email:', error);
                emailStatus.innerHTML = '<div class="status-message status-error">❌ Failed to send email. Please try downloading instead.</div>';
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '📧 Send to Email';
            }
        }

        function downloadArt() {
            if (!currentArtPath) {
                alert('Please generate art first!');
                return;
            }
            
            const filename = currentArtPath.split('/').pop();
            

            const link = document.createElement('a');
            link.href = `/download/${filename}`;
            link.download = `marble_art_${new Date().toISOString().slice(0,10)}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
 
            document.getElementById('emailStatus').innerHTML = 
                '<div class="status-message status-success">✅ Download started! Check your downloads folder.</div>';
        }

    async function resetFromArduino() {
            const resetBtn = document.getElementById('resetBtn');
            const resetStatus = document.getElementById('resetStatus');
            const artContainer = document.getElementById('artContainer');
            const artInfo = document.getElementById('artInfo');

            const orig = resetBtn.innerHTML;
            resetBtn.disabled = true;
            resetBtn.innerHTML = '<span class="loading"></span>Reading from Arduino...';
            resetStatus.innerHTML = '<div class="status-message status-info">Starting Arduino capture and clearing the canvas...</div>';

            try {
                // Call the synchronous endpoint so colors.json is guaranteed updated
                const resp = await fetch('/arduino-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ colorTimeout: 20 })
                });
                const payload = await resp.json().catch(() => ({}));
                if (!resp.ok || payload.success === false) {
                    throw new Error(payload.error || 'Reset failed');
                }
                // Clear UI state after successful capture
                currentArtPath = null;
                currentArtInfo = null;
                artContainer.innerHTML = `
                    <div class="art-placeholder">
                        Canvas cleared. Arduino colors captured. Generate new art to use the new palette.
                    </div>
                `;
                artInfo.style.display = 'none';
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('downloadBtn').disabled = true;
                const got = (payload && payload.colors && payload.colors.length) ? payload.colors.length : 0;
                resetStatus.innerHTML = `<div class="status-message status-success">✅ Captured ${got} colors from Arduino and updated palette. Click "Generate New Marble Art" to render.</div>`;
            } catch (e) {
                console.error('Reset error:', e);
                resetStatus.innerHTML = `<div class="status-message status-error">❌ ${e.message || 'Failed to reset from Arduino.'}</div>`;
            } finally {
                resetBtn.disabled = false;
                resetBtn.innerHTML = orig;
            }
        }


    </script>
</body>
</html>
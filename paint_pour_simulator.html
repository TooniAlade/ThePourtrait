<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paint Pour Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        .controls {
            margin-bottom: 20px;
        }
        .color-picker {
            margin: 10px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .tilt-display {
            margin-left: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        #sketch-container {
            border: 2px solid #333;
            border-radius: 10px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button class="color-picker" style="background: #ff6b6b;" onclick="setPaintColor('#ff6b6b')">Red</button>
        <button class="color-picker" style="background: #4ecdc4;" onclick="setPaintColor('#4ecdc4')">Cyan</button>
        <button class="color-picker" style="background: #45b7d1;" onclick="setPaintColor('#45b7d1')">Blue</button>
        <button class="color-picker" style="background: #f9ca24;" onclick="setPaintColor('#f9ca24')">Yellow</button>
        <button class="color-picker" style="background: #6c5ce7;" onclick="setPaintColor('#6c5ce7')">Purple</button>
        <button class="color-picker" style="background: #a0e7e5;" onclick="setPaintColor('#a0e7e5')">Mint</button>
        <span class="tilt-display">Tilt: <span id="tilt-value">0°</span> | Flow Rate: <span id="flow-rate">0%</span></span>
        <div style="margin-top: 15px;">
            <button onclick="togglePour()" id="pour-button" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 15px;">⏸️ Stop Pouring</button>
            <input type="text" id="user-name" placeholder="Enter your name" style="padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <input type="email" id="user-email" placeholder="Enter email for artwork" style="padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; width: 200px;">
            <button onclick="saveArtwork()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Save & Email Artwork</button>
        </div>
    </div>
    <div id="sketch-container"></div>

    <script>
        let currentPaintColor = '#ff6b6b';
        let tiltAngle = 0;
        let flowRate = 0;
        let paintDrops = [];
        let canvas;
        let canvasWidth = 800;
        let canvasHeight = 600;
        
        // Paint accumulation on canvas
        let paintCanvas;
        let paintGraphics;
        
        // Cup properties (fixed position at center top)
        let cupX;
        let cupY = 80;
        let cupWidth = 80;
        let cupHeight = 120;
        
        // Pour animation
        let pouringParticles = [];
        
        // Liquid painting flow system
        let paintLayers = [];
        let flowParticles = [];
        let centerX, centerY;
        
        // Control states
        let isPaused = false;
        let postProcessingActive = false;
        let marbleTransitionProgress = 0;
        let finalMarbleImage;
        
        function setup() {
            canvas = createCanvas(canvasWidth, canvasHeight);
            canvas.parent('sketch-container');
            
            // Position cup at center top
            cupX = canvasWidth / 2;
            centerX = canvasWidth / 2;
            centerY = canvasHeight / 2 + 50;
            
            // Create off-screen graphics for paint accumulation
            paintGraphics = createGraphics(canvasWidth, canvasHeight);
            paintGraphics.background(255, 255, 255, 0); // Transparent background
            
            // Initialize paint layers array
            paintLayers = [];
            
            // Simulate tilt changes for demo
            simulateTiltData();
        }
        
        function draw() {
            background(240);
            
            // Draw canvas area where paint accumulates
            drawPaintCanvas();
            
            // Draw the cup with tilt (fixed position)
            drawCup();
            
            // Handle liquid painting flow
            if (flowRate > 0 && !isPaused) {
                createPaintFlow();
            }
            
            // Update and draw flow particles
            updateFlowParticles();
            
            // Draw accumulated paint layers
            drawPaintLayers();
            
            // Update UI
            updateUI();
        }
        
        function drawPaintCanvas() {
            // Draw the main circular canvas area
            stroke(50);
            strokeWeight(3);
            fill(255);
            ellipse(centerX, centerY, 300, 300);
            
            // Canvas label
            fill(100);
            noStroke();
            textAlign(CENTER);
            textSize(14);
            text("Liquid Canvas", centerX, centerY - 170);
            
            // Draw guide circle for center
            stroke(200);
            strokeWeight(1);
            noFill();
            ellipse(centerX, centerY, 10, 10);
        }
        
        function drawCup() {
            push();
            
            // Move to cup position
            translate(cupX + cupWidth/2, cupY + cupHeight/2);
            rotate(radians(tiltAngle));
            
            // Draw cup body
            fill(200, 220, 255);
            stroke(100);
            strokeWeight(3);
            rectMode(CENTER);
            rect(0, 0, cupWidth, cupHeight, 8);
            
            // Draw cup handle
            noFill();
            strokeWeight(4);
            arc(cupWidth/2 + 10, 0, 25, 40);
            
            // Draw liquid inside cup
            if (flowRate < 100) {
                fill(red(currentPaintColor), green(currentPaintColor), blue(currentPaintColor), 180);
                noStroke();
                let liquidHeight = (100 - flowRate) / 100 * (cupHeight - 20);
                rect(0, cupHeight/2 - liquidHeight/2 - 10, cupWidth - 10, liquidHeight, 5);
            }
            
            // Draw pour spout highlight
            if (tiltAngle > 5) {
                fill(255, 255, 255, 150);
                noStroke();
                ellipse(cupWidth/2 - 5, -cupHeight/2 + 15, 8, 8);
            }
            
            pop();
        }
        

        
        function createPaintFlow() {
            if (tiltAngle > 15 && random() < flowRate/50) {
                // Create paint drop from cup center
                let dropX = cupX + random(-5, 5);
                let dropY = cupY + cupHeight + 10;
                
                // Initial stream particles
                for (let i = 0; i < 3; i++) {
                    let particle = {
                        x: dropX + random(-2, 2),
                        y: dropY + i * 8,
                        vx: random(-0.5, 0.5),
                        vy: 2 + random(1, 3),
                        size: random(4, 8),
                        color: currentPaintColor,
                        life: 255,
                        type: 'stream'
                    };
                    flowParticles.push(particle);
                }
            }
        }
        
        function updateFlowParticles() {
            for (let i = flowParticles.length - 1; i >= 0; i--) {
                let p = flowParticles[i];
                
                // Update position
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.1; // gravity
                p.life -= 2;
                
                // Draw stream particle
                fill(red(p.color), green(p.color), blue(p.color), p.life);
                noStroke();
                ellipse(p.x, p.y, p.size, p.size);
                
                // Check if particle hits the canvas center area
                let distToCenter = dist(p.x, p.y, centerX, centerY);
                if (distToCenter < 150 && p.type === 'stream') {
                    // Create paint layer when it hits
                    addPaintLayer(p.color, centerX, centerY);
                    flowParticles.splice(i, 1);
                } else if (p.life <= 0 || p.y > height + 50) {
                    flowParticles.splice(i, 1);
                }
            }
        }
        
        function createPaintFlow() {
            if (tiltAngle > 15 && random() < flowRate/30) {
                // Create paint drop from cup center
                let dropX = cupX + random(-3, 3);
                let dropY = cupY + cupHeight + 10;
                
                // Single stream particle falling to center
                let particle = {
                    x: dropX,
                    y: dropY,
                    vx: random(-0.3, 0.3),
                    vy: 3 + random(1, 2),
                    size: random(6, 12),
                    color: currentPaintColor,
                    life: 255,
                    type: 'stream'
                };
                flowParticles.push(particle);
            }
        }
        
        function updateFlowParticles() {
            for (let i = flowParticles.length - 1; i >= 0; i--) {
                let p = flowParticles[i];
                
                // Update position
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.1; // gravity
                p.life -= 2;
                
                // Draw stream particle
                fill(red(p.color), green(p.color), blue(p.color), p.life);
                noStroke();
                ellipse(p.x, p.y, p.size, p.size);
                
                // Check if particle hits the canvas center area
                let distToCenter = dist(p.x, p.y, centerX, centerY);
                if (distToCenter < 20 && p.type === 'stream') {
                    // Add continuous paint flow when it hits center
                    addContinuousFlow(p.color);
                    flowParticles.splice(i, 1);
                } else if (p.life <= 0 || p.y > height + 50) {
                    flowParticles.splice(i, 1);
                }
            }
        }
        
        function addContinuousFlow(color) {
            // Add paint to the center and let it flow naturally outward
            let existingLayer = paintLayers.find(layer => layer.color === color && layer.active);
            
            if (!existingLayer) {
                let layer = {
                    color: color,
                    paintFront: 15, // Starting radius of paint front
                    maxRadius: 140,
                    flowSpeed: 0.3, // Very slow natural flow
                    thickness: 8,
                    active: true,
                    startTime: millis(),
                    opacity: 200,
                    centerPool: 15 // Size of center paint pool
                };
                paintLayers.push(layer);
            } else {
                // Add more paint to existing layer
                if (existingLayer.centerPool < 25) {
                    existingLayer.centerPool += 1;
                }
                existingLayer.active = true;
            }
        }
        
        function drawPaintLayers() {
            for (let i = 0; i < paintLayers.length; i++) {
                let layer = paintLayers[i];
                
                if (layer.active && !isPaused) {
                    // Slowly expand the paint front if there's paint in the center
                    if (layer.centerPool > 15 && layer.paintFront < layer.maxRadius) {
                        layer.paintFront += layer.flowSpeed;
                        layer.centerPool -= 0.05; // Paint flows out from center
                    }
                    
                    // Stop flowing when we run out of paint or reach the edge
                    if (layer.centerPool <= 15 || layer.paintFront >= layer.maxRadius) {
                        if (layer.paintFront >= layer.maxRadius) {
                            layer.paintFront = layer.maxRadius; // Stop at edge
                        }
                        layer.active = false;
                    }
                }
                
                // Draw the paint as a filled circle (not just rings)
                let currentRadius = layer.paintFront;
                
                // Draw the main paint area as a solid circle
                fill(red(layer.color), green(layer.color), blue(layer.color), layer.opacity);
                noStroke();
                ellipse(centerX, centerY, currentRadius * 2, currentRadius * 2);
                
                // Add a subtle flowing edge effect
                if (layer.active && !isPaused) {
                    // Slightly transparent outer edge to show flow
                    fill(red(layer.color), green(layer.color), blue(layer.color), layer.opacity * 0.6);
                    ellipse(centerX, centerY, (currentRadius + 3) * 2, (currentRadius + 3) * 2);
                    
                    // Very subtle flow ripple at the edge
                    noFill();
                    stroke(red(layer.color), green(layer.color), blue(layer.color), layer.opacity * 0.3);
                    strokeWeight(1);
                    ellipse(centerX, centerY, (currentRadius + 6) * 2, (currentRadius + 6) * 2);
                }
                
                // Draw center paint pool (brighter/more opaque)
                if (layer.centerPool > 15) {
                    fill(red(layer.color), green(layer.color), blue(layer.color), 255);
                    ellipse(centerX, centerY, layer.centerPool * 2, layer.centerPool * 2);
                }
            }
        }
        
        function simulateTiltData() {
            // Simulate Arduino 9DOF sensor data
            let time = 0;
            
            function updateSensorData() {
                if (!isPaused) {
                    time += 0.02;
                    
                    // Simulate various tilt patterns for liquid painting
                    if (time < 4) {
                        // Gentle start
                        tiltAngle = sin(time * 1.0) * 25;
                    } else if (time < 10) {
                        // Active pouring phase with variations
                        tiltAngle = 30 + sin(time * 1.2) * 25;
                    } else if (time < 16) {
                        // Color change phase
                        tiltAngle = 35 + sin(time * 1.8) * 20;
                    } else if (time < 20) {
                        // Final dramatic pour
                        tiltAngle = 50 + sin(time * 2.5) * 15;
                    } else if (time < 25) {
                        // Return to upright
                        tiltAngle = lerp(tiltAngle, 0, 0.06);
                    } else {
                        // Reset cycle
                        time = 0;
                    }
                    
                    // Calculate flow rate based on tilt
                    flowRate = max(0, (tiltAngle - 15) * 2.5);
                    flowRate = constrain(flowRate, 0, 100);
                }
                
                setTimeout(updateSensorData, 50); // 20 FPS sensor update
            }
            
            updateSensorData();
        }
        
        function togglePour() {
            isPaused = !isPaused;
            const button = document.getElementById('pour-button');
            if (isPaused) {
                button.textContent = '▶️ Start Pouring';
                button.style.background = '#28a745';
            } else {
                button.textContent = '⏸️ Stop Pouring';
                button.style.background = '#dc3545';
            }
        }
        
        function updateUI() {
            document.getElementById('tilt-value').textContent = Math.round(tiltAngle) + '°';
            document.getElementById('flow-rate').textContent = Math.round(flowRate) + '%';
        }
        
        function setPaintColor(colorHex) {
            currentPaintColor = colorHex;
        }
        
        function saveArtwork() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            
            if (!name) {
                alert('Please enter your name!');
                return;
            }
            
            if (!email || !isValidEmail(email)) {
                alert('Please enter a valid email address!');
                return;
            }
            
            // Create a clean version of the artwork (circular canvas area)
            let artworkGraphics = createGraphics(350, 350);
            artworkGraphics.background(255);
            
            // Draw the circular canvas background
            artworkGraphics.fill(250);
            artworkGraphics.stroke(200);
            artworkGraphics.strokeWeight(2);
            artworkGraphics.ellipse(175, 175, 300, 300);
            
            // Render all paint layers to the artwork
            artworkGraphics.push();
            artworkGraphics.translate(175 - centerX, 175 - centerY);
            
            // Draw each paint layer as a solid filled circle
            for (let layer of paintLayers) {
                let currentRadius = layer.paintFront;
                
                // Draw the main paint area
                artworkGraphics.fill(red(layer.color), green(layer.color), blue(layer.color), layer.opacity);
                artworkGraphics.noStroke();
                artworkGraphics.ellipse(centerX, centerY, currentRadius * 2, currentRadius * 2);
                
                // Draw center paint pool if it exists
                if (layer.centerPool > 15) {
                    artworkGraphics.fill(red(layer.color), green(layer.color), blue(layer.color), 255);
                    artworkGraphics.ellipse(centerX, centerY, layer.centerPool * 2, layer.centerPool * 2);
                }
            }
            artworkGraphics.pop();
            
            // Add title to the artwork
            artworkGraphics.fill(60);
            artworkGraphics.noStroke();
            artworkGraphics.textAlign(CENTER, TOP);
            artworkGraphics.textSize(18);
            artworkGraphics.textStyle(BOLD);
            artworkGraphics.text(`${name}'s Liquid Canvas Portrait`, 175, 20);
            
            // Convert to base64 for download
            const canvas = artworkGraphics.canvas;
            const dataURL = canvas.toDataURL('image/png');
            
            // Create download link
            const link = document.createElement('a');
            link.download = `${name.replace(/\s+/g, '_')}_liquid_canvas_portrait.png`;
            link.href = dataURL;
            link.click();
            
            // Show success message with email simulation
            alert(`Artwork saved! 📨 In a real implementation, "${name}'s Liquid Canvas Portrait" would be emailed to ${email}`);
            
            // Log the email data for backend integration
            console.log('Email Data:', {
                recipientEmail: email,
                recipientName: name,
                subject: `${name}'s Liquid Canvas Portrait`,
                artworkDataURL: dataURL
            });
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Clear canvas function
        function keyPressed() {
            if (key === 'c' || key === 'C') {
                paintLayers = [];
                flowParticles = [];
            }
        }
        
        // Mouse interaction for manual tilt control
        function mouseMoved() {
            if (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
                // Manual tilt control for testing
                let manualTilt = map(mouseX, 0, width, -60, 60);
                // Uncomment next line to enable mouse control
                // tiltAngle = manualTilt;
            }
        }
    </script>
    
    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
        <h3>Instructions:</h3>
        <ul>
            <li>Select paint colors - watch the pulsing LEDs change around the cup!</li>
            <li>Use the ⏸️ <strong>Stop/Start button</strong> to control paint flow</li>
            <li>Paint flows very slowly and naturally outward from center</li>
            <li>Each color expands as a solid circle, just like real paint spreading</li>
            <li>Paint stays at the edge permanently when it reaches the border</li>
            <li>Colors layer naturally - newer colors cover older ones</li>
            <li>Press 'C' to clear and start fresh</li>
        </ul>
        <h3>Realistic Paint Flow:</h3>
        <ul>
            <li><strong>Slow Natural Expansion:</strong> Paint creeps outward slowly like real liquid</li>
            <li><strong>Solid Coverage:</strong> Paint fills the entire area as it spreads, not just rings</li>
            <li><strong>Edge Persistence:</strong> Paint stops and stays at the canvas edge naturally</li>
            <li><strong>Natural Layering:</strong> New colors flow over and cover previous colors</li>
        </ul>
        <p><strong>🎨 Realistic Physics:</strong> Paint behaves exactly like pouring liquid paint on a stationary canvas!</p>
    </div>
</body>
</html>